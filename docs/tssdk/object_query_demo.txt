// Sui å¯¹è±¡æŸ¥è¯¢æ¼”ç¤º
// æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Sui TypeScript SDK æŸ¥è¯¢ç‰¹å®šå¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯

const { SuiClient, getFullnodeUrl } = require('@mysten/sui.js/client');

// è¿æ¥åˆ° Sui æµ‹è¯•ç½‘
const client = new SuiClient({
    url: getFullnodeUrl('testnet'),
});

/**
 * æŸ¥è¯¢å¯¹è±¡çš„è¯¦ç»†ä¿¡æ¯
 * @param {string} objectId - è¦æŸ¥è¯¢çš„å¯¹è±¡ID
 */
async function queryObject(objectId) {
    try {
        console.log(`ğŸ” æŸ¥è¯¢å¯¹è±¡: ${objectId}`);
        console.log('=' .repeat(60));
        
        // è°ƒç”¨ getObject æ–¹æ³•æŸ¥è¯¢å¯¹è±¡
        const objectInfo = await client.getObject({
            id: objectId,
            options: {
                showType: true,           // æ˜¾ç¤ºå¯¹è±¡ç±»å‹
                showOwner: true,          // æ˜¾ç¤ºæ‰€æœ‰è€…ä¿¡æ¯
                showPreviousTransaction: true, // æ˜¾ç¤ºä¸Šä¸€ç¬”äº¤æ˜“
                showDisplay: true,        // æ˜¾ç¤ºæ˜¾ç¤ºå­—æ®µ
                showContent: true,        // æ˜¾ç¤ºå†…å®¹å­—æ®µ
                showBcs: true,           // æ˜¾ç¤ºBCSæ•°æ®
                showStorageRebate: true   // æ˜¾ç¤ºå­˜å‚¨é€€æ¬¾
            }
        });
        
        // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
        console.log('ğŸ“‹ å¯¹è±¡åŸºæœ¬ä¿¡æ¯:');
        console.log(`   å¯¹è±¡ID: ${objectInfo.data?.objectId || 'N/A'}`);
        console.log(`   ç‰ˆæœ¬: ${objectInfo.data?.version || 'N/A'}`);
        console.log(`   æ•°å­—åŒ–: ${objectInfo.data?.digest || 'N/A'}`);
        
        if (objectInfo.data?.type) {
            console.log(`\nğŸ·ï¸  å¯¹è±¡ç±»å‹: ${objectInfo.data.type}`);
        }
        
        if (objectInfo.data?.owner) {
            console.log('\nğŸ‘¤ æ‰€æœ‰è€…ä¿¡æ¯:');
            if (objectInfo.data.owner.AddressOwner) {
                console.log(`   åœ°å€æ‰€æœ‰è€…: ${objectInfo.data.owner.AddressOwner}`);
            } else if (objectInfo.data.owner.ObjectOwner) {
                console.log(`   å¯¹è±¡æ‰€æœ‰è€…: ${objectInfo.data.owner.ObjectOwner}`);
            } else if (objectInfo.data.owner.Shared) {
                console.log(`   å…±äº«å¯¹è±¡: ç‰ˆæœ¬ ${objectInfo.data.owner.Shared.initial_shared_version}`);
            } else {
                console.log(`   å…¶ä»–: ${JSON.stringify(objectInfo.data.owner)}`);
            }
        }
        
        if (objectInfo.data?.previousTransaction) {
            console.log(`\nğŸ”„ ä¸Šä¸€ç¬”äº¤æ˜“: ${objectInfo.data.previousTransaction}`);
        }
        
        if (objectInfo.data?.storageRebate) {
            console.log(`\nğŸ’° å­˜å‚¨é€€æ¬¾: ${objectInfo.data.storageRebalance} MIST`);
        }
        
        // if (objectInfo.data?.content) {
        //     console.log('\nğŸ“¦ å¯¹è±¡å†…å®¹:');
        //     console.log(JSON.stringify(objectInfo.data.content, null, 2));
        // }
        
        if (objectInfo.data?.display) {
            console.log('\nğŸ¨ æ˜¾ç¤ºå­—æ®µ:');
            console.log(JSON.stringify(objectInfo.data.display, null, 2));
        }
        
        if (objectInfo.data?.bcs) {
            console.log('\nğŸ”¢ BCSæ•°æ®:');
            console.log(`   å¤§å°: ${objectInfo.data.bcs.length} å­—èŠ‚`);
            console.log(`   æ•°æ®: ${objectInfo.data.bcs}`);
        }
        
        return objectInfo;
        
    } catch (error) {
        console.error('âŒ æŸ¥è¯¢å¯¹è±¡å¤±è´¥:', error.message);
        
        // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
        if (error.code === -3) {
            console.error('   å¯èƒ½åŸå› : å¯¹è±¡ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤');
        } else if (error.code === -4) {
            console.error('   å¯èƒ½åŸå› : å¯¹è±¡IDæ ¼å¼æ— æ•ˆ');
        }
        
        return null;
    }
}

/**
 * æ¼”ç¤ºæŸ¥è¯¢ä¸åŒç±»å‹çš„å¯¹è±¡
 */
async function demonstrateObjectQueries() {
    console.log('ğŸš€ Sui å¯¹è±¡æŸ¥è¯¢æ¼”ç¤º');
    console.log('=' .repeat(80));
    
    // ç¤ºä¾‹å¯¹è±¡IDåˆ—è¡¨ï¼ˆåŒ…å«ä¸åŒç±»å‹çš„å¯¹è±¡ï¼‰
    const exampleObjects = [
        {
            id: '0x6b0c51f4925126d690619091b317fda87d1cd5223e82ecb0bcb6ded3baa3d91d',
            description: 'æ™ºèƒ½åˆçº¦åŒ…'
        },
        {
            id: '0x0000000000000000000000000000000000000000000000000000000000000006',
            description: 'ç³»ç»Ÿå¯¹è±¡ï¼ˆæ—¶é’Ÿï¼‰'
        }
    ];
    
    for (const example of exampleObjects) {
        console.log(`\nğŸ“Œ æŸ¥è¯¢ç¤ºä¾‹: ${example.description}`);
        await queryObject(example.id);
        console.log('\n' + '='.repeat(80));
    }
}

/**
 * äº¤äº’å¼å¯¹è±¡æŸ¥è¯¢
 */
async function interactiveQuery() {
    const readline = require('readline');
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
    });
    
    const question = (prompt) => {
        return new Promise((resolve) => {
            rl.question(prompt, resolve);
        });
    };
    
    console.log('\nğŸ¯ äº¤äº’å¼å¯¹è±¡æŸ¥è¯¢');
    console.log('è¯·è¾“å…¥è¦æŸ¥è¯¢çš„å¯¹è±¡IDï¼ˆæˆ–è¾“å…¥ "exit" é€€å‡ºï¼‰:');
    
    while (true) {
        const objectId = await question('\nå¯¹è±¡ID: ');
        
        if (objectId.toLowerCase() === 'exit') {
            break;
        }
        
        if (!objectId || !objectId.startsWith('0x')) {
            console.log('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„å¯¹è±¡IDï¼ˆä»¥0xå¼€å¤´ï¼‰');
            continue;
        }
        
        await queryObject(objectId);
    }
    
    rl.close();
    console.log('ğŸ‘‹ æ„Ÿè°¢ä½¿ç”¨ï¼');
}

// ä¸»å‡½æ•°
async function main() {
    try {
        // æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°
        const args = process.argv.slice(2);
        
        if (args.length > 0) {
            // å¦‚æœæä¾›äº†å¯¹è±¡IDå‚æ•°ï¼Œç›´æ¥æŸ¥è¯¢è¯¥å¯¹è±¡
            const objectId = args[0];
            console.log('ğŸ¯ å•å¯¹è±¡æŸ¥è¯¢æ¨¡å¼');
            await queryObject(objectId);
        } else {
            // å¦åˆ™è¿è¡Œæ¼”ç¤º
            await demonstrateObjectQueries();
            
            // è¯¢é—®æ˜¯å¦è¿›è¡Œäº¤äº’å¼æŸ¥è¯¢
            const readline = require('readline');
            const rl = readline.createInterface({
                input: process.stdin,
                output: process.stdout
            });
            
            const question = (prompt) => {
                return new Promise((resolve) => {
                    rl.question(prompt, resolve);
                });
            };
            
            const answer = await question('\næ˜¯å¦è¿›è¡Œäº¤äº’å¼æŸ¥è¯¢ï¼Ÿ(y/n): ');
            rl.close();
            
            if (answer.toLowerCase() === 'y' || answer.toLowerCase() === 'yes') {
                await interactiveQuery();
            }
        }
        
    } catch (error) {
        console.error('ç¨‹åºæ‰§è¡Œå¤±è´¥:', error);
    }
}

// å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶
if (require.main === module) {
    main().catch(console.error);
}

// å¯¼å‡ºå‡½æ•°ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
module.exports = {
    queryObject,
    demonstrateObjectQueries,
    interactiveQuery
};
